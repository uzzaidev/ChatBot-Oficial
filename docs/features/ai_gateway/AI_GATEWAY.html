<!DOCTYPE html><html><head>
      <title>AI_GATEWAY</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\Luisf\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.8.20\crossnote\dependencies\katex\katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="vercel-ai-gateway---guia-completo">Vercel AI Gateway - Guia Completo </h1>
<h2 id="-Ã­ndice">ğŸ“‹ Ãndice </h2>
<ul>
<li><a href="#o-que-%C3%A9-vercel-ai-gateway">O que Ã© Vercel AI Gateway?</a></li>
<li><a href="#vantagens-e-benef%C3%ADcios">Vantagens e BenefÃ­cios</a></li>
<li><a href="#compara%C3%A7%C3%A3o-com-a-arquitetura-atual">ComparaÃ§Ã£o com a Arquitetura Atual</a></li>
<li><a href="#como-funciona">Como Funciona</a></li>
<li><a href="#guia-de-implementa%C3%A7%C3%A3o">Guia de ImplementaÃ§Ã£o</a></li>
<li><a href="#exemplos-de-c%C3%B3digo">Exemplos de CÃ³digo</a></li>
<li><a href="#migra%C3%A7%C3%A3o-da-arquitetura-atual">MigraÃ§Ã£o da Arquitetura Atual</a></li>
<li><a href="#considera%C3%A7%C3%B5es-multi-tenant">ConsideraÃ§Ãµes Multi-Tenant</a></li>
<li><a href="#seguran%C3%A7a-e-boas-pr%C3%A1ticas">SeguranÃ§a e Boas PrÃ¡ticas</a></li>
<li><a href="#custos-e-pricing">Custos e Pricing</a></li>
<li><a href="#monitoramento-e-m%C3%A9tricas">Monitoramento e MÃ©tricas</a></li>
<li><a href="#refer%C3%AAncias">ReferÃªncias</a></li>
</ul>
<hr>
<h2 id="o-que-Ã©-vercel-ai-gateway">O que Ã© Vercel AI Gateway? </h2>
<p><strong>Vercel AI Gateway</strong> Ã© uma plataforma unificada que simplifica o acesso e gerenciamento de <strong>centenas de modelos de IA</strong> de diversos provedores (OpenAI, Anthropic, Google, Meta, xAI, Groq, Mistral e mais) atravÃ©s de um <strong>Ãºnico endpoint de API</strong>.</p>
<h3 id="problema-que-resolve">Problema que Resolve </h3>
<p>Atualmente, ao trabalhar com mÃºltiplos provedores de IA, vocÃª precisa:</p>
<ul>
<li>âŒ Gerenciar mÃºltiplos SDKs (OpenAI SDK, Groq SDK, Anthropic SDK, etc.)</li>
<li>âŒ Manter diferentes formatos de API e autenticaÃ§Ã£o</li>
<li>âŒ Implementar lÃ³gica de fallback manualmente</li>
<li>âŒ Criar seu prÃ³prio sistema de mÃ©tricas e tracking</li>
<li>âŒ Lidar com rate limiting de cada provedor separadamente</li>
<li>âŒ Implementar cache e retry logic para cada SDK</li>
</ul>
<h3 id="soluÃ§Ã£o">SoluÃ§Ã£o </h3>
<p>Com Vercel AI Gateway:</p>
<ul>
<li>âœ… <strong>Um Ãºnico SDK</strong> para todos os provedores</li>
<li>âœ… <strong>Uma interface unificada</strong> para todos os modelos</li>
<li>âœ… <strong>Fallback automÃ¡tico</strong> quando um provedor estÃ¡ down</li>
<li>âœ… <strong>MÃ©tricas built-in</strong> em dashboard centralizado</li>
<li>âœ… <strong>Rate limiting global</strong> gerenciado automaticamente</li>
<li>âœ… <strong>Caching inteligente</strong> para reduzir custos e latÃªncia</li>
<li>âœ… <strong>Observabilidade completa</strong> de todos os requests</li>
</ul>
<hr>
<h2 id="vantagens-e-benefÃ­cios">Vantagens e BenefÃ­cios </h2>
<h3 id="1--acesso-unificado-a-mÃºltiplos-modelos">1. ğŸ”„ Acesso Unificado a MÃºltiplos Modelos </h3>
<p><strong>BenefÃ­cio:</strong> Acesse <strong>mais de 100 modelos de IA</strong> com uma Ãºnica API.</p>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token comment">// Antes: CÃ³digo diferente para cada provedor</span>
<span class="token keyword keyword-import">import</span> OpenAI <span class="token keyword keyword-from">from</span> <span class="token string">'openai'</span>
<span class="token keyword keyword-import">import</span> Groq <span class="token keyword keyword-from">from</span> <span class="token string">'groq-sdk'</span>
<span class="token keyword keyword-import">import</span> Anthropic <span class="token keyword keyword-from">from</span> <span class="token string">'@anthropic-ai/sdk'</span>

<span class="token keyword keyword-const">const</span> openai <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">OpenAI</span><span class="token punctuation">(</span><span class="token punctuation">{</span> apiKey<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">OPENAI_API_KEY</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword keyword-const">const</span> groq <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Groq</span><span class="token punctuation">(</span><span class="token punctuation">{</span> apiKey<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">GROQ_API_KEY</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword keyword-const">const</span> anthropic <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Anthropic</span><span class="token punctuation">(</span><span class="token punctuation">{</span> apiKey<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">ANTHROPIC_API_KEY</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Depois: Uma Ãºnica interface</span>
<span class="token class-name"><span class="token keyword keyword-import">import</span></span> <span class="token punctuation">{</span> streamText <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'ai'</span>

<span class="token comment">// Trocar de modelo Ã© sÃ³ mudar o nome</span>
<span class="token keyword keyword-const">const</span> result <span class="token operator">=</span> <span class="token function">streamText</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  model<span class="token operator">:</span> <span class="token string">'openai/gpt-4'</span><span class="token punctuation">,</span>  <span class="token comment">// ou 'anthropic/claude-3-5-sonnet', 'groq/llama-3.3-70b'</span>
  messages
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><p><strong>Vantagem:</strong> Experimente e troque modelos <strong>sem reescrever cÃ³digo</strong> - apenas mude o nome do modelo.</p>
<h3 id="2--mÃ©tricas-e-observabilidade-built-in">2. ğŸ“Š MÃ©tricas e Observabilidade Built-in </h3>
<p><strong>BenefÃ­cio:</strong> Dashboard centralizado com mÃ©tricas detalhadas de <strong>todos os requests</strong>.</p>
<p><strong>O que vocÃª obtÃ©m:</strong></p>
<ul>
<li>ğŸ“ˆ Uso por modelo (requests, tokens, custos)</li>
<li>â±ï¸ LatÃªncia mÃ©dia e P95/P99</li>
<li>ğŸš¨ Taxa de erro por provedor</li>
<li>ğŸ’° DistribuiÃ§Ã£o de custos em tempo real</li>
<li>ğŸ” Logs granulares de cada request</li>
<li>ğŸ“‰ TendÃªncias de uso ao longo do tempo</li>
</ul>
<p><strong>ComparaÃ§Ã£o com implementaÃ§Ã£o manual:</strong></p>
<table>
<thead>
<tr>
<th>Recurso</th>
<th>ImplementaÃ§Ã£o Atual</th>
<th>Com AI Gateway</th>
</tr>
</thead>
<tbody>
<tr>
<td>Tracking de tokens</td>
<td>Manual (usageTracking.ts)</td>
<td>âœ… AutomÃ¡tico</td>
</tr>
<tr>
<td>Custos por modelo</td>
<td>CÃ¡lculo manual</td>
<td>âœ… Dashboard em tempo real</td>
</tr>
<tr>
<td>LatÃªncia de requests</td>
<td>Sem tracking</td>
<td>âœ… P50/P95/P99 automÃ¡ticos</td>
</tr>
<tr>
<td>Logs de erro</td>
<td>Console logs</td>
<td>âœ… Dashboard centralizado</td>
</tr>
<tr>
<td>Analytics histÃ³rico</td>
<td>Precisa construir</td>
<td>âœ… Built-in</td>
</tr>
</tbody>
</table>
<h3 id="3--caching-inteligente">3. ğŸ’¾ Caching Inteligente </h3>
<p><strong>BenefÃ­cio:</strong> Reduza <strong>custos e latÃªncia</strong> automaticamente.</p>
<p><strong>Como funciona:</strong></p>
<ul>
<li>Requests idÃªnticos retornam resposta cacheada (latÃªncia ~20ms)</li>
<li>Cache gerenciado automaticamente pelo Gateway</li>
<li>ConfigurÃ¡vel por modelo e tempo de expiraÃ§Ã£o</li>
</ul>
<p><strong>Exemplo de economia:</strong></p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>Sem cache:
- 1000 requests idÃªnticos/dia = 1000 Ã— $0.03 = $30/dia
- LatÃªncia mÃ©dia: 800ms

Com cache (hit rate 70%):
- 300 requests reais + 700 cache = 300 Ã— $0.03 = $9/dia
- LatÃªncia mÃ©dia: 200ms (700 requests em 20ms)
- Economia: 70% de custos + 75% menos latÃªncia
</code></pre><h3 id="4--failover-automÃ¡tico">4. ğŸ”„ Failover AutomÃ¡tico </h3>
<p><strong>BenefÃ­cio:</strong> Alta disponibilidade <strong>sem cÃ³digo adicional</strong>.</p>
<p><strong>Funcionamento:</strong></p>
<ul>
<li>Se OpenAI estÃ¡ rate-limited â†’ automaticamente tenta Groq</li>
<li>Se um provedor estÃ¡ down â†’ redireciona para backup</li>
<li>Load balancing entre provedores para distribuir carga</li>
</ul>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token comment">// ConfiguraÃ§Ã£o de fallback</span>
<span class="token keyword keyword-const">const</span> result <span class="token operator">=</span> <span class="token function">streamText</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  model<span class="token operator">:</span> <span class="token string">'openai/gpt-4'</span><span class="token punctuation">,</span>
  fallbacks<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'anthropic/claude-3-5-sonnet'</span><span class="token punctuation">,</span> <span class="token string">'groq/llama-3.3-70b'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Gateway tenta automaticamente na ordem definida</span>
<span class="token comment">// VocÃª nÃ£o precisa tratar falhas manualmente</span>
</code></pre><h3 id="5-ï¸-rate-limiting-global">5. ğŸ›¡ï¸ Rate Limiting Global </h3>
<p><strong>BenefÃ­cio:</strong> Evite ultrapassar limites de API <strong>automaticamente</strong>.</p>
<ul>
<li>Rate limiting inteligente por provedor</li>
<li>DistribuiÃ§Ã£o automÃ¡tica de requests entre provedores</li>
<li>ProteÃ§Ã£o contra burst traffic</li>
</ul>
<h3 id="6--transparÃªncia-de-custos">6. ğŸ’° TransparÃªncia de Custos </h3>
<p><strong>BenefÃ­cio:</strong> Visibilidade total de gastos <strong>em tempo real</strong>.</p>
<ul>
<li>Custos por modelo, por cliente, por dia</li>
<li>Sem markup (Vercel cobra preÃ§os de mercado)</li>
<li>Suporte a BYOK (Bring Your Own Key) para billing direto</li>
<li>Alertas de budget configurÃ¡veis</li>
</ul>
<h3 id="7--performance">7. ğŸš€ Performance </h3>
<p><strong>BenefÃ­cio:</strong> LatÃªncia ultra-baixa de <strong>~20ms</strong> para gerenciamento.</p>
<ul>
<li>Overhead mÃ­nimo (20ms) comparado aos requests diretos</li>
<li>Edge network global da Vercel</li>
<li>OtimizaÃ§Ã£o de rotas para menor latÃªncia</li>
</ul>
<hr>
<h2 id="comparaÃ§Ã£o-com-a-arquitetura-atual">ComparaÃ§Ã£o com a Arquitetura Atual </h2>
<h3 id="arquitetura-atual-srclibopenaits--groqts">Arquitetura Atual (src/lib/openai.ts + groq.ts) </h3>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token comment">// âŒ MÃºltiplos SDKs para gerenciar</span>
<span class="token keyword keyword-import">import</span> OpenAI <span class="token keyword keyword-from">from</span> <span class="token string">'openai'</span>
<span class="token keyword keyword-import">import</span> Groq <span class="token keyword keyword-from">from</span> <span class="token string">'groq-sdk'</span>

<span class="token comment">// âŒ LÃ³gica de seleÃ§Ã£o manual</span>
<span class="token keyword keyword-const">const</span> client <span class="token operator">=</span> config<span class="token punctuation">.</span>aiProvider <span class="token operator">===</span> <span class="token string">'openai'</span> 
  <span class="token operator">?</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">OpenAI</span><span class="token punctuation">(</span><span class="token punctuation">{</span> apiKey <span class="token punctuation">}</span><span class="token punctuation">)</span> 
  <span class="token operator">:</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Groq</span><span class="token punctuation">(</span><span class="token punctuation">{</span> apiKey <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// âŒ Tracking manual de uso</span>
<span class="token keyword keyword-await">await</span> <span class="token function">trackUsage</span><span class="token punctuation">(</span>clientId<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  model<span class="token operator">:</span> response<span class="token punctuation">.</span>model<span class="token punctuation">,</span>
  inputTokens<span class="token operator">:</span> response<span class="token punctuation">.</span>usage<span class="token punctuation">.</span>prompt_tokens<span class="token punctuation">,</span>
  outputTokens<span class="token operator">:</span> response<span class="token punctuation">.</span>usage<span class="token punctuation">.</span>completion_tokens
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// âŒ Sem fallback automÃ¡tico</span>
<span class="token comment">// âŒ Sem mÃ©tricas centralizadas</span>
<span class="token comment">// âŒ Sem cache automÃ¡tico</span>
</code></pre><p><strong>Problemas:</strong></p>
<ul>
<li>ğŸ”´ CÃ³digo duplicado entre provedores</li>
<li>ğŸ”´ Sem failover automÃ¡tico</li>
<li>ğŸ”´ MÃ©tricas fragmentadas (precisa consultar Supabase)</li>
<li>ğŸ”´ Sem cache inteligente</li>
<li>ğŸ”´ Rate limiting manual</li>
<li>ğŸ”´ DifÃ­cil adicionar novos provedores</li>
</ul>
<h3 id="arquitetura-com-ai-gateway">Arquitetura com AI Gateway </h3>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token comment">// âœ… SDK Ãºnico</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> streamText <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'ai'</span>

<span class="token comment">// âœ… SeleÃ§Ã£o simplificada</span>
<span class="token keyword keyword-const">const</span> result <span class="token operator">=</span> <span class="token function">streamText</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  model<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>aiProvider<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>modelName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  messages<span class="token punctuation">,</span>
  <span class="token comment">// âœ… Fallback automÃ¡tico</span>
  fallbacks<span class="token operator">:</span> config<span class="token punctuation">.</span>fallbackModels
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// âœ… MÃ©tricas automÃ¡ticas no dashboard Vercel</span>
<span class="token comment">// âœ… Cache gerenciado automaticamente</span>
<span class="token comment">// âœ… Rate limiting global</span>
<span class="token comment">// âœ… Failover sem cÃ³digo adicional</span>
</code></pre><p><strong>Vantagens:</strong></p>
<ul>
<li>ğŸŸ¢ CÃ³digo 70% menor</li>
<li>ğŸŸ¢ Failover automÃ¡tico</li>
<li>ğŸŸ¢ MÃ©tricas em tempo real no dashboard</li>
<li>ğŸŸ¢ Cache inteligente built-in</li>
<li>ğŸŸ¢ Rate limiting gerenciado</li>
<li>ğŸŸ¢ Adicionar provedor = mudar string</li>
</ul>
<hr>
<h2 id="como-funciona">Como Funciona </h2>
<h3 id="fluxo-de-request">Fluxo de Request </h3>
<pre data-role="codeBlock" data-info="" class="language-text"><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Next.js    â”‚  1. Request com model name
â”‚  App        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
                                     â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ Vercel AI      â”‚
                            â”‚ Gateway        â”‚
                            â”‚                â”‚
                            â”‚ â€¢ Routing      â”‚
                            â”‚ â€¢ Cache check  â”‚
                            â”‚ â€¢ Metrics      â”‚
                            â”‚ â€¢ Fallback     â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                â–¼                â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ OpenAI   â”‚    â”‚  Groq    â”‚    â”‚Anthropic â”‚
              â”‚ GPT-4    â”‚    â”‚ Llama 3  â”‚    â”‚ Claude   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre><h3 id="recursos-automÃ¡ticos">Recursos AutomÃ¡ticos </h3>
<ol>
<li><strong>Request Routing:</strong> Gateway encaminha para o provedor correto</li>
<li><strong>Cache Lookup:</strong> Verifica se resposta estÃ¡ em cache</li>
<li><strong>Metrics Collection:</strong> Registra tokens, latÃªncia, custos</li>
<li><strong>Automatic Retry:</strong> Tenta novamente em caso de falha</li>
<li><strong>Fallback:</strong> Troca de provedor se necessÃ¡rio</li>
<li><strong>Response Streaming:</strong> Retorna tokens progressivamente</li>
</ol>
<hr>
<h2 id="guia-de-implementaÃ§Ã£o">Guia de ImplementaÃ§Ã£o </h2>
<h3 id="passo-1-instalar-dependÃªncias">Passo 1: Instalar DependÃªncias </h3>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">npm</span> <span class="token function">install</span> ai @ai-sdk/react zod
</code></pre><p><strong>Pacotes:</strong></p>
<ul>
<li><code>ai</code> - Core do Vercel AI SDK</li>
<li><code>@ai-sdk/react</code> - React hooks para IA (useChat, useCompletion)</li>
<li><code>zod</code> - ValidaÃ§Ã£o de schemas (para tool calls)</li>
</ul>
<h3 id="passo-2-configurar-variÃ¡veis-de-ambiente">Passo 2: Configurar VariÃ¡veis de Ambiente </h3>
<pre data-role="codeBlock" data-info="env" class="language-env env"><code># .env.local

# Vercel AI Gateway (substitui chaves individuais)
AI_GATEWAY_API_KEY=your-vercel-ai-gateway-key

# Ou BYOK (Bring Your Own Key) - billing direto com provedores
OPENAI_API_KEY=sk-...
GROQ_API_KEY=gsk_...
ANTHROPIC_API_KEY=sk-ant-...
</code></pre><p><strong>Onde obter a chave:</strong></p>
<ol>
<li>Acesse <a href="https://vercel.com/dashboard">Vercel Dashboard</a></li>
<li>VÃ¡ em <strong>AI Gateway</strong> no menu lateral</li>
<li>Clique em <strong>Get API Key</strong></li>
<li>Copie e adicione ao <code>.env.local</code></li>
</ol>
<h3 id="passo-3-criar-api-route">Passo 3: Criar API Route </h3>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token comment">// src/app/api/chat/route.ts</span>

<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> streamText <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'ai'</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> runtime <span class="token operator">=</span> <span class="token string">'edge'</span> <span class="token comment">// Opcional: edge runtime para menor latÃªncia</span>
<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> dynamic <span class="token operator">=</span> <span class="token string">'force-dynamic'</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token constant">POST</span><span class="token punctuation">(</span>req<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-const">const</span> <span class="token punctuation">{</span> messages<span class="token punctuation">,</span> model <span class="token operator">=</span> <span class="token string">'openai/gpt-4'</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> req<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-const">const</span> result <span class="token operator">=</span> <span class="token function">streamText</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      model<span class="token punctuation">,</span> <span class="token comment">// Ex: 'groq/llama-3.3-70b', 'anthropic/claude-3-5-sonnet'</span>
      messages<span class="token punctuation">,</span>
      temperature<span class="token operator">:</span> <span class="token number">0.7</span><span class="token punctuation">,</span>
      maxTokens<span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
      <span class="token comment">// Fallback automÃ¡tico</span>
      fallbacks<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">'anthropic/claude-3-5-sonnet'</span><span class="token punctuation">,</span>
        <span class="token string">'groq/llama-3.3-70b'</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// Retorna stream de resposta</span>
    <span class="token keyword keyword-return">return</span> result<span class="token punctuation">.</span><span class="token function">toDataStreamResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'AI Gateway error:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">'Error generating response'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token number">500</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="passo-4-usar-no-frontend">Passo 4: Usar no Frontend </h3>
<pre data-role="codeBlock" data-info="tsx" class="language-tsx tsx"><code><span class="token comment">// src/components/ChatInterface.tsx</span>

<span class="token string">'use client'</span>

<span class="token keyword keyword-import">import</span> <span class="token imports"><span class="token punctuation">{</span> useChat <span class="token punctuation">}</span></span> <span class="token keyword keyword-from">from</span> <span class="token string">'@ai-sdk/react'</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> <span class="token function-variable function">ChatInterface</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> <span class="token punctuation">{</span> messages<span class="token punctuation">,</span> input<span class="token punctuation">,</span> handleInputChange<span class="token punctuation">,</span> handleSubmit<span class="token punctuation">,</span> isLoading <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useChat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    api<span class="token operator">:</span> <span class="token string">'/api/chat'</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> <span class="token punctuation">{</span>
      model<span class="token operator">:</span> <span class="token string">'groq/llama-3.3-70b'</span> <span class="token comment">// ConfigurÃ¡vel por cliente</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>flex flex-col h-screen<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span><span class="token comment">/* Messages */</span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>flex-1 overflow-y-auto p-4<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span>messages<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">(</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>msg<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>msg<span class="token punctuation">.</span><span class="token property-access">role</span> <span class="token operator">===</span> <span class="token string">'user'</span> <span class="token operator">?</span> <span class="token string">'text-right'</span> <span class="token operator">:</span> <span class="token string">'text-left'</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>inline-block p-3 rounded-lg bg-gray-100<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
              </span><span class="token punctuation">{</span>msg<span class="token punctuation">.</span><span class="token property-access">content</span><span class="token punctuation">}</span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token punctuation">{</span>isLoading <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">IA estÃ¡ pensando...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">

      </span><span class="token punctuation">{</span><span class="token comment">/* Input */</span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">onSubmit</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleSubmit<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>p-4 border-t<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
          <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>input<span class="token punctuation">}</span></span>
          <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>handleInputChange<span class="token punctuation">}</span></span>
          <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Digite sua mensagem...<span class="token punctuation">"</span></span>
          <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>w-full p-2 border rounded<span class="token punctuation">"</span></span>
        <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mt-2 px-4 py-2 bg-blue-500 text-white rounded<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
          Enviar
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><hr>
<h2 id="exemplos-de-cÃ³digo">Exemplos de CÃ³digo </h2>
<h3 id="exemplo-1-chat-completion-com-streaming">Exemplo 1: Chat Completion com Streaming </h3>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token comment">// src/app/api/chat/route.ts</span>

<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> streamText <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'ai'</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token constant">POST</span><span class="token punctuation">(</span>req<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> <span class="token punctuation">{</span> messages<span class="token punctuation">,</span> clientId <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> req<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// Buscar configuraÃ§Ã£o do cliente do Supabase Vault</span>
  <span class="token keyword keyword-const">const</span> config <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token function">getClientConfig</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span>

  <span class="token keyword keyword-const">const</span> result <span class="token operator">=</span> <span class="token function">streamText</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    model<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>aiProvider<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>modelName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    messages<span class="token punctuation">,</span>
    temperature<span class="token operator">:</span> config<span class="token punctuation">.</span>temperature <span class="token operator">||</span> <span class="token number">0.7</span><span class="token punctuation">,</span>
    maxTokens<span class="token operator">:</span> config<span class="token punctuation">.</span>maxTokens <span class="token operator">||</span> <span class="token number">1000</span><span class="token punctuation">,</span>
    systemPrompt<span class="token operator">:</span> config<span class="token punctuation">.</span>systemPrompt<span class="token punctuation">,</span>
    
    <span class="token comment">// Callbacks para tracking custom (opcional)</span>
    <span class="token function-variable function">onFinish</span><span class="token operator">:</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> usage<span class="token punctuation">,</span> response <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// Ainda pode fazer tracking no Supabase se necessÃ¡rio</span>
      <span class="token keyword keyword-await">await</span> <span class="token function">trackUsageInSupabase</span><span class="token punctuation">(</span>clientId<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        model<span class="token operator">:</span> response<span class="token punctuation">.</span>model<span class="token punctuation">,</span>
        inputTokens<span class="token operator">:</span> usage<span class="token punctuation">.</span>promptTokens<span class="token punctuation">,</span>
        outputTokens<span class="token operator">:</span> usage<span class="token punctuation">.</span>completionTokens
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword keyword-return">return</span> result<span class="token punctuation">.</span><span class="token function">toDataStreamResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="exemplo-2-tool-calls-sub-agentes">Exemplo 2: Tool Calls (Sub-agentes) </h3>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> streamText<span class="token punctuation">,</span> tool <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'ai'</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> z <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'zod'</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token constant">POST</span><span class="token punctuation">(</span>req<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> <span class="token punctuation">{</span> messages <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> req<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword keyword-const">const</span> result <span class="token operator">=</span> <span class="token function">streamText</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    model<span class="token operator">:</span> <span class="token string">'openai/gpt-4'</span><span class="token punctuation">,</span>
    messages<span class="token punctuation">,</span>
    tools<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// Tool para transferir para humano</span>
      transfer_to_human<span class="token operator">:</span> <span class="token function">tool</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        description<span class="token operator">:</span> <span class="token string">'Transfer conversation to human agent'</span><span class="token punctuation">,</span>
        parameters<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          reason<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Reason for transfer'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          urgency<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">enum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'low'</span><span class="token punctuation">,</span> <span class="token string">'medium'</span><span class="token punctuation">,</span> <span class="token string">'high'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function-variable function">execute</span><span class="token operator">:</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> reason<span class="token punctuation">,</span> urgency <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword keyword-await">await</span> <span class="token function">createTransferRequest</span><span class="token punctuation">(</span>reason<span class="token punctuation">,</span> urgency<span class="token punctuation">)</span>
          <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span> success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token string">'Transferido para atendimento humano'</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      
      <span class="token comment">// Tool para buscar documentos</span>
      search_knowledge<span class="token operator">:</span> <span class="token function">tool</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        description<span class="token operator">:</span> <span class="token string">'Search in knowledge base'</span><span class="token punctuation">,</span>
        parameters<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          query<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function-variable function">execute</span><span class="token operator">:</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> query <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword keyword-const">const</span> results <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token function">searchInVectorStore</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span>
          <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span> results <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword keyword-return">return</span> result<span class="token punctuation">.</span><span class="token function">toDataStreamResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="exemplo-3-transcriÃ§Ã£o-de-Ã¡udio">Exemplo 3: TranscriÃ§Ã£o de Ãudio </h3>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> transcribeAudio <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'ai'</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token constant">POST</span><span class="token punctuation">(</span>req<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> formData <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> req<span class="token punctuation">.</span><span class="token function">formData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-const">const</span> audioFile <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'audio'</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> File

  <span class="token keyword keyword-const">const</span> result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token function">transcribeAudio</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    model<span class="token operator">:</span> <span class="token string">'openai/whisper-1'</span><span class="token punctuation">,</span>
    file<span class="token operator">:</span> audioFile<span class="token punctuation">,</span>
    language<span class="token operator">:</span> <span class="token string">'pt'</span><span class="token punctuation">,</span> <span class="token comment">// PortuguÃªs</span>
    responseFormat<span class="token operator">:</span> <span class="token string">'json'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword keyword-return">return</span> Response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    text<span class="token operator">:</span> result<span class="token punctuation">.</span>text<span class="token punctuation">,</span>
    duration<span class="token operator">:</span> result<span class="token punctuation">.</span>duration<span class="token punctuation">,</span>
    language<span class="token operator">:</span> result<span class="token punctuation">.</span>language
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="exemplo-4-anÃ¡lise-de-imagem">Exemplo 4: AnÃ¡lise de Imagem </h3>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> generateText <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'ai'</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token constant">POST</span><span class="token punctuation">(</span>req<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> <span class="token punctuation">{</span> imageUrl<span class="token punctuation">,</span> prompt <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> req<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword keyword-const">const</span> result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token function">generateText</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    model<span class="token operator">:</span> <span class="token string">'openai/gpt-4o'</span><span class="token punctuation">,</span> <span class="token comment">// Modelo com vision</span>
    messages<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        role<span class="token operator">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span>
        content<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span> text<span class="token operator">:</span> prompt <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'image'</span><span class="token punctuation">,</span> image<span class="token operator">:</span> imageUrl <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword keyword-return">return</span> Response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> description<span class="token operator">:</span> result<span class="token punctuation">.</span>text <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><hr>
<h2 id="migraÃ§Ã£o-da-arquitetura-atual">MigraÃ§Ã£o da Arquitetura Atual </h2>
<h3 id="fase-1-preparaÃ§Ã£o-sem-breaking-changes">Fase 1: PreparaÃ§Ã£o (Sem Breaking Changes) </h3>
<p><strong>Objetivo:</strong> Adicionar AI Gateway como opÃ§Ã£o paralela.</p>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token comment">// src/lib/ai-gateway.ts (NOVO ARQUIVO)</span>

<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> streamText<span class="token punctuation">,</span> generateText <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'ai'</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> <span class="token function-variable function">generateAIResponseWithGateway</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span>
  messages<span class="token operator">:</span> ChatMessage<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  config<span class="token operator">:</span> ClientConfig
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token function">streamText</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    model<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>aiProvider<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>modelName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    messages<span class="token punctuation">,</span>
    temperature<span class="token operator">:</span> config<span class="token punctuation">.</span>temperature<span class="token punctuation">,</span>
    maxTokens<span class="token operator">:</span> config<span class="token punctuation">.</span>maxTokens<span class="token punctuation">,</span>
    systemPrompt<span class="token operator">:</span> config<span class="token punctuation">.</span>systemPrompt
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword keyword-return">return</span> result
<span class="token punctuation">}</span>
</code></pre><p><strong>Modificar apenas a API route para testar:</strong></p>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token comment">// src/app/api/webhook/[clientId]/route.ts</span>

<span class="token keyword keyword-const">const</span> <span class="token constant">USE_AI_GATEWAY</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">ENABLE_AI_GATEWAY</span> <span class="token operator">===</span> <span class="token string">'true'</span> <span class="token comment">// Feature flag</span>

<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token constant">USE_AI_GATEWAY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  response <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token function">generateAIResponseWithGateway</span><span class="token punctuation">(</span>messages<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// MantÃ©m lÃ³gica atual</span>
  response <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token function">generateAIResponse</span><span class="token punctuation">(</span>messages<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>Vantagens desta abordagem:</strong></p>
<ul>
<li>âœ… Zero downtime</li>
<li>âœ… Pode testar em staging primeiro</li>
<li>âœ… Rollback instantÃ¢neo (mudar feature flag)</li>
<li>âœ… Comparar performance lado a lado</li>
</ul>
<h3 id="fase-2-migraÃ§Ã£o-gradual">Fase 2: MigraÃ§Ã£o Gradual </h3>
<ol>
<li>
<p><strong>Migrar 10% do trÃ¡fego:</strong></p>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-const">const</span> <span class="token constant">USE_AI_GATEWAY</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.1</span> <span class="token comment">// 10% de chance</span>
</code></pre></li>
<li>
<p><strong>Monitorar mÃ©tricas:</strong></p>
<ul>
<li>LatÃªncia (Gateway vs. direto)</li>
<li>Taxa de erro</li>
<li>Custos</li>
<li>SatisfaÃ§Ã£o de resposta</li>
</ul>
</li>
<li>
<p><strong>Aumentar gradualmente:</strong></p>
<ul>
<li>10% â†’ 25% â†’ 50% â†’ 100%</li>
</ul>
</li>
</ol>
<h3 id="fase-3-consolidaÃ§Ã£o">Fase 3: ConsolidaÃ§Ã£o </h3>
<p><strong>Remover cÃ³digo legado apÃ³s validaÃ§Ã£o completa:</strong></p>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token comment">// âŒ REMOVER (apÃ³s migraÃ§Ã£o 100%)</span>
<span class="token comment">// src/lib/openai.ts</span>
<span class="token comment">// src/lib/groq.ts</span>

<span class="token comment">// âœ… MANTER (simplificado)</span>
<span class="token comment">// src/lib/ai-gateway.ts (Ãºnico arquivo para todos os provedores)</span>
</code></pre><p><strong>BenefÃ­cios apÃ³s migraÃ§Ã£o:</strong></p>
<ul>
<li>ğŸ“‰ ~500 linhas de cÃ³digo a menos</li>
<li>ğŸš€ ManutenÃ§Ã£o 70% mais simples</li>
<li>ğŸ“Š MÃ©tricas unificadas</li>
<li>ğŸ’° Melhor controle de custos</li>
</ul>
<h3 id="exemplo-de-cÃ³digo-migrado">Exemplo de CÃ³digo Migrado </h3>
<p><strong>Antes (generateAIResponse.ts - 200 linhas):</strong></p>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token comment">// LÃ³gica complexa de seleÃ§Ã£o de provedor</span>
<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>aiProvider <span class="token operator">===</span> <span class="token string">'openai'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> client <span class="token operator">=</span> <span class="token function">getOpenAIClient</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>openaiApiKey<span class="token punctuation">)</span>
  <span class="token keyword keyword-const">const</span> response <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>aiProvider <span class="token operator">===</span> <span class="token string">'groq'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> client <span class="token operator">=</span> <span class="token function">getGroqClient</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>groqApiKey<span class="token punctuation">)</span>
  <span class="token keyword keyword-const">const</span> response <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Tracking manual</span>
<span class="token keyword keyword-await">await</span> <span class="token function">trackUsage</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>

<span class="token comment">// Sem fallback automÃ¡tico</span>
<span class="token comment">// Sem cache</span>
<span class="token comment">// Sem mÃ©tricas centralizadas</span>
</code></pre><p><strong>Depois (ai-gateway.ts - 50 linhas):</strong></p>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> streamText <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'ai'</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-const">const</span> <span class="token function-variable function">generateAIResponse</span> <span class="token operator">=</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span>messages<span class="token punctuation">,</span> config<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-return">return</span> <span class="token function">streamText</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    model<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>aiProvider<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>modelName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    messages<span class="token punctuation">,</span>
    temperature<span class="token operator">:</span> config<span class="token punctuation">.</span>temperature<span class="token punctuation">,</span>
    <span class="token comment">// Gateway cuida de: fallback, cache, metrics, rate limiting</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// MÃ©tricas automÃ¡ticas no dashboard Vercel</span>
<span class="token comment">// Fallback automÃ¡tico configurado</span>
<span class="token comment">// Cache gerenciado pelo Gateway</span>
</code></pre><hr>
<h2 id="consideraÃ§Ãµes-multi-tenant">ConsideraÃ§Ãµes Multi-Tenant </h2>
<h3 id="problema-gerenciar-api-keys-por-cliente">Problema: Gerenciar API Keys por Cliente </h3>
<p><strong>Arquitetura atual:</strong></p>
<ul>
<li>Cada cliente tem suas prÃ³prias API keys no Supabase Vault</li>
<li>Diferentes provedores (OpenAI, Groq) por cliente</li>
</ul>
<p><strong>SoluÃ§Ã£o com AI Gateway:</strong></p>
<h3 id="opÃ§Ã£o-1-gateway-key-Ãºnica-recomendado-para-custo">OpÃ§Ã£o 1: Gateway Key Ãšnica (Recomendado para Custo) </h3>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token comment">// Todos os clientes usam a mesma Gateway Key</span>
<span class="token comment">// Vercel gerencia billing e vocÃª cobra os clientes</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token constant">POST</span><span class="token punctuation">(</span>req<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> <span class="token punctuation">{</span> clientId<span class="token punctuation">,</span> messages <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> req<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  
  <span class="token comment">// Buscar configuraÃ§Ã£o do cliente (modelo preferido)</span>
  <span class="token keyword keyword-const">const</span> config <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token function">getClientConfig</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span>
  
  <span class="token keyword keyword-const">const</span> result <span class="token operator">=</span> <span class="token function">streamText</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    model<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>aiProvider<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>modelName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    messages<span class="token punctuation">,</span>
    <span class="token comment">// Gateway Key Ãºnica (do env)</span>
    <span class="token comment">// Vercel cobra vocÃª pelo uso total</span>
    <span class="token function-variable function">onFinish</span><span class="token operator">:</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> usage <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// Calcular custo e cobrar cliente</span>
      <span class="token keyword keyword-const">const</span> cost <span class="token operator">=</span> <span class="token function">calculateCost</span><span class="token punctuation">(</span>usage<span class="token punctuation">,</span> config<span class="token punctuation">.</span>modelName<span class="token punctuation">)</span>
      <span class="token keyword keyword-await">await</span> billingService<span class="token punctuation">.</span><span class="token function">chargeClient</span><span class="token punctuation">(</span>clientId<span class="token punctuation">,</span> cost<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
  <span class="token keyword keyword-return">return</span> result<span class="token punctuation">.</span><span class="token function">toDataStreamResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>Vantagens:</strong></p>
<ul>
<li>âœ… Simplificado (uma key apenas)</li>
<li>âœ… VocÃª controla pricing markup</li>
<li>âœ… MÃ©tricas consolidadas</li>
</ul>
<p><strong>Desvantagens:</strong></p>
<ul>
<li>âŒ VocÃª assume risco de billing</li>
<li>âŒ Precisa gerenciar cobranÃ§as</li>
</ul>
<h3 id="opÃ§Ã£o-2-byok-bring-your-own-key-por-cliente">OpÃ§Ã£o 2: BYOK (Bring Your Own Key) por Cliente </h3>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token comment">// Cada cliente usa suas prÃ³prias keys</span>
<span class="token comment">// Billing direto com provedores</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token constant">POST</span><span class="token punctuation">(</span>req<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> <span class="token punctuation">{</span> clientId<span class="token punctuation">,</span> messages <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> req<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  
  <span class="token keyword keyword-const">const</span> config <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token function">getClientConfig</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span>
  
  <span class="token comment">// Passar API key do cliente para o Gateway</span>
  <span class="token keyword keyword-const">const</span> result <span class="token operator">=</span> <span class="token function">streamText</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    model<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>aiProvider<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>modelName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    messages<span class="token punctuation">,</span>
    <span class="token comment">// Gateway usa a key do cliente</span>
    apiKey<span class="token operator">:</span> config<span class="token punctuation">.</span>openaiApiKey<span class="token punctuation">,</span> <span class="token comment">// ou groqApiKey</span>
    <span class="token function-variable function">onFinish</span><span class="token operator">:</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> usage <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// Apenas tracking (billing jÃ¡ Ã© direto com provedor)</span>
      <span class="token keyword keyword-await">await</span> <span class="token function">trackUsage</span><span class="token punctuation">(</span>clientId<span class="token punctuation">,</span> usage<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
  <span class="token keyword keyword-return">return</span> result<span class="token punctuation">.</span><span class="token function">toDataStreamResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>Vantagens:</strong></p>
<ul>
<li>âœ… Zero risco de billing</li>
<li>âœ… Cliente paga diretamente provedor</li>
<li>âœ… Clientes podem usar seus prÃ³prios crÃ©ditos</li>
</ul>
<p><strong>Desvantagens:</strong></p>
<ul>
<li>âŒ Precisa gerenciar mÃºltiplas keys</li>
<li>âŒ Clientes precisam criar contas nos provedores</li>
</ul>
<h3 id="recomendaÃ§Ã£o-para-o-projeto">RecomendaÃ§Ã£o para o Projeto </h3>
<p><strong>HÃ­brido:</strong></p>
<ul>
<li>Clientes free/starter â†’ Gateway Key Ãºnica (vocÃª gerencia)</li>
<li>Clientes enterprise â†’ BYOK (billing direto)</li>
</ul>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-const">const</span> config <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token function">getClientConfig</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span>

<span class="token keyword keyword-const">const</span> apiConfig <span class="token operator">=</span> config<span class="token punctuation">.</span>plan <span class="token operator">===</span> <span class="token string">'enterprise'</span>
  <span class="token operator">?</span> <span class="token punctuation">{</span> apiKey<span class="token operator">:</span> config<span class="token punctuation">.</span>openaiApiKey <span class="token punctuation">}</span> <span class="token comment">// BYOK</span>
  <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// Gateway Key padrÃ£o</span>

<span class="token keyword keyword-const">const</span> result <span class="token operator">=</span> <span class="token function">streamText</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  model<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>aiProvider<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>modelName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  messages<span class="token punctuation">,</span>
  <span class="token operator">...</span>apiConfig
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><hr>
<h2 id="seguranÃ§a-e-boas-prÃ¡ticas">SeguranÃ§a e Boas PrÃ¡ticas </h2>
<h3 id="1-autenticaÃ§Ã£o">1. AutenticaÃ§Ã£o </h3>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token comment">// middleware.ts - Proteger API routes</span>

<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> createServerClient <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@/lib/supabase'</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token function">middleware</span><span class="token punctuation">(</span>req<span class="token operator">:</span> NextRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> supabase <span class="token operator">=</span> <span class="token function">createServerClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-const">const</span> <span class="token punctuation">{</span> data<span class="token operator">:</span> <span class="token punctuation">{</span> user <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> supabase<span class="token punctuation">.</span>auth<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  
  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>nextUrl<span class="token punctuation">.</span>pathname<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'/api/chat'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">'Unauthorized'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token number">401</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword keyword-return">return</span> NextResponse<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="2-rate-limiting-por-cliente">2. Rate Limiting por Cliente </h3>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> Ratelimit <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@upstash/ratelimit'</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> Redis <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@upstash/redis'</span>

<span class="token keyword keyword-const">const</span> ratelimit <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Ratelimit</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  redis<span class="token operator">:</span> Redis<span class="token punctuation">.</span><span class="token function">fromEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  limiter<span class="token operator">:</span> Ratelimit<span class="token punctuation">.</span><span class="token function">slidingWindow</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">'1 h'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 100 requests/hora</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token constant">POST</span><span class="token punctuation">(</span>req<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> <span class="token punctuation">{</span> clientId <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> req<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  
  <span class="token keyword keyword-const">const</span> <span class="token punctuation">{</span> success<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> remaining <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> ratelimit<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span>
  
  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">'Rate limit exceeded'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token number">429</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// Continue com o request...</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="3-sanitizaÃ§Ã£o-de-input">3. SanitizaÃ§Ã£o de Input </h3>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> z <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'zod'</span>

<span class="token keyword keyword-const">const</span> messageSchema <span class="token operator">=</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  messages<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    role<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">enum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'assistant'</span><span class="token punctuation">,</span> <span class="token string">'system'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span> <span class="token comment">// Limite de caracteres</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  clientId<span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token constant">POST</span><span class="token punctuation">(</span>req<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> body <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> req<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  
  <span class="token comment">// Validar input</span>
  <span class="token keyword keyword-const">const</span> validation <span class="token operator">=</span> messageSchema<span class="token punctuation">.</span><span class="token function">safeParse</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
  
  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validation<span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">'Invalid input'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token number">400</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword keyword-const">const</span> <span class="token punctuation">{</span> messages<span class="token punctuation">,</span> clientId <span class="token punctuation">}</span> <span class="token operator">=</span> validation<span class="token punctuation">.</span>data
  <span class="token comment">// Continue...</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="4-timeout-e-error-handling">4. Timeout e Error Handling </h3>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-export">export</span> <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token constant">POST</span><span class="token punctuation">(</span>req<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-const">const</span> result <span class="token operator">=</span> <span class="token function">streamText</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      model<span class="token operator">:</span> <span class="token string">'openai/gpt-4'</span><span class="token punctuation">,</span>
      messages<span class="token punctuation">,</span>
      maxRetries<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// Tenta 2 vezes se falhar</span>
      abortSignal<span class="token operator">:</span> AbortSignal<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token number">30000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 30s timeout</span>
      fallbacks<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'anthropic/claude-3-5-sonnet'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token keyword keyword-return">return</span> result<span class="token punctuation">.</span><span class="token function">toDataStreamResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'TimeoutError'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">'Request timeout'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token number">408</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">429</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">'Rate limit exceeded'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token number">429</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// Log error mas nÃ£o exponha detalhes</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'AI Gateway error:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">'Error generating response'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token number">500</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="5-content-moderation">5. Content Moderation </h3>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> moderate <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'ai'</span>

<span class="token keyword keyword-export">export</span> <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-function">function</span> <span class="token constant">POST</span><span class="token punctuation">(</span>req<span class="token operator">:</span> Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> <span class="token punctuation">{</span> messages <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> req<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  
  <span class="token comment">// Moderar conteÃºdo antes de enviar para IA</span>
  <span class="token keyword keyword-const">const</span> lastMessage <span class="token operator">=</span> messages<span class="token punctuation">[</span>messages<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>content
  
  <span class="token keyword keyword-const">const</span> moderation <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> <span class="token function">moderate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    model<span class="token operator">:</span> <span class="token string">'openai/text-moderation-latest'</span><span class="token punctuation">,</span>
    input<span class="token operator">:</span> lastMessage
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>moderation<span class="token punctuation">.</span>flagged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">'Content violates policy'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> 
      status<span class="token operator">:</span> <span class="token number">400</span><span class="token punctuation">,</span>
      body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> categories<span class="token operator">:</span> moderation<span class="token punctuation">.</span>categories <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// Continue com request...</span>
<span class="token punctuation">}</span>
</code></pre><hr>
<h2 id="custos-e-pricing">Custos e Pricing </h2>
<h3 id="modelo-de-pricing-do-vercel-ai-gateway">Modelo de Pricing do Vercel AI Gateway </h3>
<p><strong>Gateway:</strong></p>
<ul>
<li>âœ… <strong>Sem markup</strong> sobre preÃ§os dos provedores</li>
<li>âœ… <strong>Billing transparente</strong> - paga apenas o que usa</li>
<li>âœ… <strong>BYOK suportado</strong> - use suas prÃ³prias keys</li>
</ul>
<p><strong>Custos tÃ­picos (por 1M tokens):</strong></p>
<table>
<thead>
<tr>
<th>Provedor</th>
<th>Modelo</th>
<th>Input</th>
<th>Output</th>
</tr>
</thead>
<tbody>
<tr>
<td>OpenAI</td>
<td>GPT-4o</td>
<td>$2.50</td>
<td>$10.00</td>
</tr>
<tr>
<td>OpenAI</td>
<td>GPT-4o-mini</td>
<td>$0.15</td>
<td>$0.60</td>
</tr>
<tr>
<td>Anthropic</td>
<td>Claude 3.5 Sonnet</td>
<td>$3.00</td>
<td>$15.00</td>
</tr>
<tr>
<td>Groq</td>
<td>Llama 3.3 70B</td>
<td>$0.59</td>
<td>$0.79</td>
</tr>
<tr>
<td>Groq</td>
<td>Llama 3.1 8B</td>
<td>$0.05</td>
<td>$0.08</td>
</tr>
</tbody>
</table>
<h3 id="estimativa-de-economia-com-cache">Estimativa de Economia com Cache </h3>
<p><strong>CenÃ¡rio:</strong> 10.000 requests/dia, 70% hit rate de cache</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>Sem cache:
- 10.000 requests Ã— 1000 tokens Ã— $0.001/1k tokens = $10/dia
- Total: $300/mÃªs

Com cache (70% hit):
- 3.000 requests reais Ã— 1000 tokens Ã— $0.001/1k tokens = $3/dia
- Total: $90/mÃªs
- Economia: $210/mÃªs (70%)
</code></pre><h3 id="comparaÃ§Ã£o-de-custos-implementaÃ§Ã£o-atual-vs-ai-gateway">ComparaÃ§Ã£o de Custos: ImplementaÃ§Ã£o Atual vs. AI Gateway </h3>
<p><strong>ImplementaÃ§Ã£o Atual:</strong></p>
<ul>
<li>API keys diretas com provedores</li>
<li>Sem cache automÃ¡tico</li>
<li>Tracking manual (custos de infraestrutura Supabase)</li>
<li>Sem otimizaÃ§Ã£o de rotas</li>
</ul>
<p><strong>Com AI Gateway:</strong></p>
<ul>
<li>Billing consolidado</li>
<li>Cache automÃ¡tico (economia ~50-70%)</li>
<li>MÃ©tricas incluÃ­das</li>
<li>Roteamento otimizado (menor latÃªncia = menos re-requests)</li>
</ul>
<p><strong>Exemplo para 100k requests/mÃªs:</strong></p>
<table>
<thead>
<tr>
<th>Item</th>
<th>Atual</th>
<th>Com Gateway</th>
<th>Economia</th>
</tr>
</thead>
<tbody>
<tr>
<td>API calls</td>
<td>$500</td>
<td>$200</td>
<td>$300 (cache)</td>
</tr>
<tr>
<td>Tracking infra</td>
<td>$50</td>
<td>$0</td>
<td>$50</td>
</tr>
<tr>
<td>MÃ©tricas/logs</td>
<td>$30</td>
<td>$0</td>
<td>$30</td>
</tr>
<tr>
<td><strong>Total</strong></td>
<td><strong>$580</strong></td>
<td><strong>$200</strong></td>
<td><strong>$380 (65%)</strong></td>
</tr>
</tbody>
</table>
<hr>
<h2 id="monitoramento-e-mÃ©tricas">Monitoramento e MÃ©tricas </h2>
<h3 id="dashboard-do-vercel-ai-gateway">Dashboard do Vercel AI Gateway </h3>
<p>Acesse: <a href="https://vercel.com/dashboard/ai-gateway">Vercel Dashboard â†’ AI Gateway</a></p>
<p><strong>MÃ©tricas disponÃ­veis:</strong></p>
<h4 id="1-overview">1. Overview </h4>
<ul>
<li>ğŸ“Š Total de requests (Ãºltimas 24h, 7d, 30d)</li>
<li>ğŸ’° Custos totais e por modelo</li>
<li>âš¡ LatÃªncia mÃ©dia (P50, P95, P99)</li>
<li>ğŸ¯ Taxa de sucesso vs. erros</li>
</ul>
<h4 id="2-por-modelo">2. Por Modelo </h4>
<pre data-role="codeBlock" data-info="" class="language-text"><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Model Performance                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ openai/gpt-4         12,450 requests    â”‚
â”‚ â”œâ”€ Avg latency: 850ms                   â”‚
â”‚ â”œâ”€ Success rate: 99.2%                  â”‚
â”‚ â””â”€ Cost: $245.50                        â”‚
â”‚                                         â”‚
â”‚ groq/llama-3.3-70b   8,320 requests     â”‚
â”‚ â”œâ”€ Avg latency: 320ms                   â”‚
â”‚ â”œâ”€ Success rate: 99.8%                  â”‚
â”‚ â””â”€ Cost: $12.40                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre><h4 id="3-cache-performance">3. Cache Performance </h4>
<ul>
<li>ğŸ¯ Hit rate (%)</li>
<li>ğŸ’¾ Requests servidos do cache</li>
<li>ğŸ’° Economia estimada</li>
</ul>
<h4 id="4-logs-detalhados">4. Logs Detalhados </h4>
<ul>
<li>Cada request individual</li>
<li>Timestamps, latÃªncia, tokens usados</li>
<li>Erros e stack traces</li>
<li>User/client ID (se configurado)</li>
</ul>
<h3 id="integraÃ§Ã£o-com-ferramentas-existentes">IntegraÃ§Ã£o com Ferramentas Existentes </h3>
<p><strong>Continuar usando Supabase Analytics:</strong></p>
<pre data-role="codeBlock" data-info="typescript" class="language-typescript typescript"><code><span class="token comment">// src/app/api/chat/route.ts</span>

<span class="token keyword keyword-import">import</span> <span class="token punctuation">{</span> trackUsage <span class="token punctuation">}</span> <span class="token keyword keyword-from">from</span> <span class="token string">'@/lib/usageTracking'</span>

<span class="token keyword keyword-const">const</span> result <span class="token operator">=</span> <span class="token function">streamText</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  model<span class="token operator">:</span> <span class="token string">'openai/gpt-4'</span><span class="token punctuation">,</span>
  messages<span class="token punctuation">,</span>
  <span class="token function-variable function">onFinish</span><span class="token operator">:</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> usage<span class="token punctuation">,</span> response <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Ainda pode salvar no Supabase para analytics custom</span>
    <span class="token keyword keyword-await">await</span> <span class="token function">trackUsage</span><span class="token punctuation">(</span>clientId<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      model<span class="token operator">:</span> response<span class="token punctuation">.</span>model<span class="token punctuation">,</span>
      inputTokens<span class="token operator">:</span> usage<span class="token punctuation">.</span>promptTokens<span class="token punctuation">,</span>
      outputTokens<span class="token operator">:</span> usage<span class="token punctuation">.</span>completionTokens<span class="token punctuation">,</span>
      cost<span class="token operator">:</span> <span class="token function">calculateCost</span><span class="token punctuation">(</span>usage<span class="token punctuation">,</span> response<span class="token punctuation">.</span>model<span class="token punctuation">)</span><span class="token punctuation">,</span>
      conversationId<span class="token punctuation">,</span>
      messageId
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><p><strong>BenefÃ­cios de dual tracking:</strong></p>
<ul>
<li>âœ… Vercel: MÃ©tricas tÃ©cnicas (latÃªncia, erros, cache)</li>
<li>âœ… Supabase: Analytics de negÃ³cio (uso por cliente, ROI, trends)</li>
</ul>
<hr>
<h2 id="prÃ³ximos-passos-recomendados">PrÃ³ximos Passos Recomendados </h2>
<h3 id="fase-1-exploraÃ§Ã£o-1-2-dias">Fase 1: ExploraÃ§Ã£o (1-2 dias) </h3>
<ol>
<li>âœ… Criar conta Vercel (se ainda nÃ£o tem)</li>
<li>âœ… Ativar AI Gateway no dashboard</li>
<li>âœ… Obter API key de teste</li>
<li>âœ… Testar com exemplo simples</li>
</ol>
<h3 id="fase-2-proof-of-concept-1-semana">Fase 2: Proof of Concept (1 semana) </h3>
<ol>
<li>âœ… Criar branch <code>feature/ai-gateway-poc</code></li>
<li>âœ… Implementar API route paralela (<code>/api/chat-gateway</code>)</li>
<li>âœ… Testar com 1 cliente em staging</li>
<li>âœ… Comparar mÃ©tricas: latÃªncia, custos, taxa de erro</li>
</ol>
<h3 id="fase-3-migraÃ§Ã£o-gradual-2-3-semanas">Fase 3: MigraÃ§Ã£o Gradual (2-3 semanas) </h3>
<ol>
<li>âœ… Feature flag para habilitar Gateway por cliente</li>
<li>âœ… Migrar 10% do trÃ¡fego</li>
<li>âœ… Monitorar mÃ©tricas por 1 semana</li>
<li>âœ… Aumentar para 50% se tudo ok</li>
<li>âœ… Migrar 100% apÃ³s validaÃ§Ã£o</li>
</ol>
<h3 id="fase-4-otimizaÃ§Ã£o-ongoing">Fase 4: OtimizaÃ§Ã£o (ongoing) </h3>
<ol>
<li>âœ… Configurar cache policies</li>
<li>âœ… Ajustar fallback strategies</li>
<li>âœ… Implementar alertas de budget</li>
<li>âœ… Remover cÃ³digo legado</li>
</ol>
<hr>
<h2 id="referÃªncias">ReferÃªncias </h2>
<h3 id="documentaÃ§Ã£o-oficial">DocumentaÃ§Ã£o Oficial </h3>
<ul>
<li><a href="https://vercel.com/docs/ai-gateway">Vercel AI Gateway - Docs</a></li>
<li><a href="https://ai-sdk.dev/">Vercel AI SDK - Docs</a></li>
<li><a href="https://ai-sdk.dev/providers/ai-sdk-providers/ai-gateway">AI Gateway Providers</a></li>
<li><a href="https://ai-sdk.dev/docs/getting-started/nextjs-app-router">Next.js App Router Integration</a></li>
</ul>
<h3 id="templates-e-exemplos">Templates e Exemplos </h3>
<ul>
<li><a href="https://vercel.com/templates/next.js/vercel-ai-gateway-demo">Vercel AI Gateway Demo</a></li>
<li><a href="https://vercel.com/templates/next.js/nextjs-ai-chatbot">AI Chatbot Template</a></li>
</ul>
<h3 id="artigos-e-tutoriais">Artigos e Tutoriais </h3>
<ul>
<li><a href="https://benseymour.com/blog/2025-09-13-Building-an-AI-Chatbot-with-Vercel-AI-SDK-and-AI-Gateway">Building an AI Chatbot with Vercel AI SDK</a></li>
<li><a href="https://blog.logrocket.com/nextjs-vercel-ai-sdk-streaming/">Real-time AI in Next.js with Vercel AI SDK</a></li>
<li><a href="https://www.infoq.com/news/2025/09/vercel-ai-gateway/">Vercel Introduces AI Gateway - InfoQ</a></li>
</ul>
<h3 id="comunidade">Comunidade </h3>
<ul>
<li><a href="https://github.com/vercel/ai">Vercel AI SDK GitHub</a></li>
<li><a href="https://vercel.com/discord">Discord da Vercel</a></li>
</ul>
<hr>
<h2 id="perguntas-frequentes">Perguntas Frequentes </h2>
<h3 id="p-preciso-migrar-tudo-de-uma-vez">P: Preciso migrar tudo de uma vez? </h3>
<p><strong>R:</strong> NÃ£o! Use feature flags para migrar gradualmente. Pode comeÃ§ar com 10% do trÃ¡fego.</p>
<h3 id="p-vou-perder-as-mÃ©tricas-atuais-do-supabase">P: Vou perder as mÃ©tricas atuais do Supabase? </h3>
<p><strong>R:</strong> NÃ£o. Pode continuar salvando no Supabase em paralelo para analytics de negÃ³cio.</p>
<h3 id="p-como-funcionam-os-custos-com-mÃºltiplos-clientes">P: Como funcionam os custos com mÃºltiplos clientes? </h3>
<p><strong>R:</strong> VocÃª pode usar uma Gateway Key Ãºnica (vocÃª gerencia billing) ou BYOK (cliente paga direto).</p>
<h3 id="p-e-se-eu-quiser-voltar-para-a-implementaÃ§Ã£o-atual">P: E se eu quiser voltar para a implementaÃ§Ã£o atual? </h3>
<p><strong>R:</strong> Basta mudar a feature flag. Zero vendor lock-in.</p>
<h3 id="p-cache-funciona-com-mensagens-diferentes">P: Cache funciona com mensagens diferentes? </h3>
<p><strong>R:</strong> Cache Ã© inteligente - funciona para requests idÃªnticos (mesmo prompt + contexto).</p>
<h3 id="p-como-funciona-fallback-automÃ¡tico">P: Como funciona fallback automÃ¡tico? </h3>
<p><strong>R:</strong> Configure array de fallbacks. Gateway tenta na ordem se o primeiro falhar.</p>
<h3 id="p-posso-usar-modelos-locaiscustom">P: Posso usar modelos locais/custom? </h3>
<p><strong>R:</strong> Sim, AI Gateway suporta endpoints custom alÃ©m dos provedores principais.</p>
<hr>
<h2 id="conclusÃ£o">ConclusÃ£o </h2>
<p><strong>Vercel AI Gateway Ã© uma soluÃ§Ã£o moderna e poderosa</strong> para gerenciar mÃºltiplos modelos de IA em produÃ§Ã£o. Para este projeto, os principais benefÃ­cios seriam:</p>
<h3 id="benefÃ­cios-principais-para-o-projeto">BenefÃ­cios Principais para o Projeto </h3>
<ol>
<li>
<p><strong>ğŸ”„ SimplificaÃ§Ã£o de CÃ³digo</strong></p>
<ul>
<li>ReduÃ§Ã£o de ~500 linhas de cÃ³digo</li>
<li>ManutenÃ§Ã£o 70% mais simples</li>
<li>Menos SDKs para gerenciar</li>
</ul>
</li>
<li>
<p><strong>ğŸ“Š MÃ©tricas Unificadas</strong></p>
<ul>
<li>Dashboard centralizado</li>
<li>Visibilidade total de custos</li>
<li>Analytics em tempo real</li>
</ul>
</li>
<li>
<p><strong>ğŸ’° ReduÃ§Ã£o de Custos</strong></p>
<ul>
<li>Cache automÃ¡tico (economia ~50-70%)</li>
<li>Roteamento inteligente</li>
<li>Sem custos de infraestrutura de tracking</li>
</ul>
</li>
<li>
<p><strong>ğŸ›¡ï¸ Maior Confiabilidade</strong></p>
<ul>
<li>Failover automÃ¡tico</li>
<li>Rate limiting global</li>
<li>Alta disponibilidade (99.9%+)</li>
</ul>
</li>
<li>
<p><strong>ğŸš€ Melhor Performance</strong></p>
<ul>
<li>LatÃªncia otimizada</li>
<li>Edge network global</li>
<li>Streaming eficiente</li>
</ul>
</li>
</ol>
<h3 id="recomendaÃ§Ã£o-final">RecomendaÃ§Ã£o Final </h3>
<p><strong>âœ… Recomendo a adoÃ§Ã£o</strong> do Vercel AI Gateway para este projeto, com migraÃ§Ã£o gradual:</p>
<ul>
<li><strong>Curto prazo (1 mÃªs):</strong> POC com 10% do trÃ¡fego</li>
<li><strong>MÃ©dio prazo (3 meses):</strong> MigraÃ§Ã£o completa</li>
<li><strong>Longo prazo:</strong> OtimizaÃ§Ã£o e economia contÃ­nua</li>
</ul>
<p>O investimento inicial de tempo Ã© compensado pela <strong>reduÃ§Ã£o de manutenÃ§Ã£o, melhor observabilidade e economia de custos</strong> a longo prazo.</p>
<hr>
<p><strong>Documento criado em:</strong> 2024-12-11<br>
<strong>Ãšltima atualizaÃ§Ã£o:</strong> 2024-12-11<br>
<strong>VersÃ£o:</strong> 1.0</p>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>