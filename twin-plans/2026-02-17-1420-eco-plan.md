# Twin Development Plan (Econômico)
Generated: 2026-02-17
Task: Webhook único - migration + waba-lookup + POST handler + auto-provision

## Análise Rápida

`meta_waba_id` já existe na tabela `clients` mas sem unique constraint nem index. As colunas `webhook_routing_mode`, `auto_provisioned`, `provisioned_at` não existem — OAuth callback tenta inserir mas falha silenciosamente. `getClientConfig(clientId)` já existe e retorna ClientConfig completo com Vault — basta resolver WABA ID → client UUID.

## Arquivos a Criar/Modificar

- `supabase/migrations/20260217000001_webhook_routing_fields.sql` - unique constraint + index + novas colunas
- `src/lib/waba-lookup.ts` - WABA ID → ClientConfig com cache Redis
- `src/lib/auto-provision.ts` - handler para WABA desconhecido (log + notify, sem criar client)
- `src/app/api/webhook/route.ts` - completar POST handler com WABA lookup + chatbotFlow

## Passos

1. Criar migration e rodar `supabase db push`
2. Verificar como redis.ts exporta o client (adaptar waba-lookup.ts)
3. Criar waba-lookup.ts
4. Criar auto-provision.ts (mínimo)
5. Completar POST handler em webhook/route.ts
6. Type check: npx tsc --noEmit

## Riscos

- Verificar se `meta_waba_id` já existe como coluna no DB real antes da migration
- `config.status` pode não existir em ClientConfig — filtrar direto no DB lookup por status='active'
- Redis serialization de API keys sensíveis — usar cache in-memory simples se Redis não tiver TLS
- Não criar clients automaticamente no auto-provision (risco de spam) — apenas logar

## Próximo Passo

ok
